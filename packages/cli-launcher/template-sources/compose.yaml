# Docker Compose Configuration for Baseboards
name: ${PROJECT_NAME:-baseboards}

services:
  db:
    image: postgres:16
    env_file: docker/.env
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks:
      - internal

  cache:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - internal

  api:
    # Pre-built backend image from GitHub Container Registry
    # Override version with BACKEND_VERSION in docker/.env (defaults to latest)
    image: ghcr.io/weirdfingers/boards-backend:${BACKEND_VERSION:-latest}
    command: ["uvicorn", "boards.api.app:app", "--host", "0.0.0.0", "--port", "8800"]
    env_file:
      - docker/.env
      - api/.env
    environment:
      # Enable loading custom generators and plugins from /app/extensions
      # Include /app/src for the boards module (from Docker image)
      - PYTHONPATH=/app/src:/app/extensions
      # Explicit paths to configuration files
      - BOARDS_GENERATORS_CONFIG_PATH=/app/config/generators.yaml
      - BOARDS_STORAGE_CONFIG_PATH=/app/config/storage_config.yaml
      # Ensure logs are visible in real-time (no buffering)
      - PYTHONUNBUFFERED=1
    volumes:
      # Configuration files (read-only)
      - ./config:/app/config:ro
      # Generated media persistence (read-write)
      - ./data/storage:/app/data/storage
      # Custom generators and plugins (read-only)
      - ./extensions:/app/extensions:ro
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy
    ports:
      - "${API_PORT:-8800}:8800"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8800/health"]
      interval: 30s
      timeout: 3s
      retries: 50
    networks:
      - internal

  worker:
    # Pre-built backend image from GitHub Container Registry
    # Override version with BACKEND_VERSION in docker/.env (defaults to latest)
    image: ghcr.io/weirdfingers/boards-backend:${BACKEND_VERSION:-latest}
    command:
      [
        "boards-worker",
        "--log-level",
        "debug",
        "--processes",
        "1",
        "--threads",
        "1",
      ]
    env_file:
      - docker/.env
      - api/.env
    environment:
      # Enable loading custom generators and plugins from /app/extensions
      # Include /app/src for the boards module (from Docker image)
      - PYTHONPATH=/app/src:/app/extensions
      # Explicit paths to configuration files
      - BOARDS_GENERATORS_CONFIG_PATH=/app/config/generators.yaml
      - BOARDS_STORAGE_CONFIG_PATH=/app/config/storage_config.yaml
      # Internal API URL for worker communication
      - BOARDS_INTERNAL_API_URL=http://api:8800
      # Ensure logs are visible in real-time (no buffering)
      - PYTHONUNBUFFERED=1
    volumes:
      # Configuration files (read-only)
      - ./config:/app/config:ro
      # Generated media persistence (read-write)
      - ./data/storage:/app/data/storage
      # Custom generators and plugins (read-only)
      - ./extensions:/app/extensions:ro
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy
    networks:
      - internal

networks:
  internal:
    driver: bridge

volumes:
  db-data:
